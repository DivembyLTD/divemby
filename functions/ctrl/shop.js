'use strict';

const errorHandler = require('strong-error-handler');
const db = require('./../lib/firebase');
const helpers = require('./../lib/helpers');
const _ = require('lodash');
const utilities = require('./utilities');
const Storage = require('@google-cloud/storage');
const axios = require('axios');
const storage = Storage({
  projectId: "divemby-fb",
  keyFilename: "./divemby-fb-firebase-adminsdk-d6iqf-c98baf092c.json"
});

const Promise = require('bluebird');

const tmp = require('tmp');
const fs = require('fs');

let getImg = (id, ext) => {
  return new Promise((resolve, reject) => {
    axios({
      method:'get',
      url:'http://kupi-korm.ru/pictures/product/small/' + id + '_small.' + ext,
    }).then(response => {
      resolve(id + '_small.' + ext);
    }, err => {
      resolve(null);
    });
  });
}

module.exports = () => {
  return {
    importCatImg: (req, res) => {
      const bucket = storage.bucket("divemby-fb.appspot.com");
      let ids = req.body.ids;

      // let ids = ["11201","11202","11203","11204","11210","11205","11206","11434","11435","11436","11211","11437","11438","11439","11440","11441","11442","11443","10821","10822","11535","8909","10823","11544","11546","11547","11548","11536","11543","11537","10826","11538","11539","11540","10830","11541","11542","9037","13261","12195","13262","13264","13263","11550","11552","13266","13268","13270","13272","13274","13276","13278","13281","13283","13285","13287","13289","13291","13293","13294","13296","13298","13300","8635","8636","7698","11815","8638","7699","7700","8639","7701","8640","11819","11823","11825","8644","8645","7702","11827","7703","7704","8647","7705","12134","12133","7819","8744","8745","8746","8747","7820","8748","8749","7821","8750","8751","7822","7823","7824","8752","8753","11561","11598","11597","11594","11593","11592","8855","8856","8857","8858","8859","8860","8861","8862","8863","11563","11564","11565","11566","11568","11569","11570","11572","11587","9416","9420","9433","9442","9504","9505","11901","9507","11902","9509","9510","9511","9512","11903","9514","9517","9518","9519","9521","9526","12140","12137","12138","9528","9529","12139","9531","9532","9533","9534","11904","9536","11577","11578","11579","11580","11583","11584","11585","11998","11999","12000","5477","12007","12009","12008","12012","12010","12011","12311","12314","12316","12317","12320","12322","12318","12323","12325","12326","12327","12328","12329","12330","12331","12332","12333","12334","12335","12336","12337","12339","12340","12341","12342","12343","12344","12345","12346","12347","12348","12349","12350","12351","12352","12353","12354","12355","12356","12357","12358","12359","12360","12361","12362","12363","12364","12365","12366","12367","12368","12369","12370","12371","12372","12373","12374","12375","12049","12050","12051","12052","12055","12063","12065","12066","12067","12068","12073","12070","12071","12072","12074","12075","12076","12077","12078","12086","12087","12082","12084","12088","12089","12090","12091","12092","12093","12094","12096","12097","12098","12114","12099","12100","12104","12102","12105","12106","12107","12108","12109","12110","12111","12112","12113","12803","12013","10141","8893","8894","8895","12891","8910","8911","8912","8913","9005","9024","9025","9026","9027","10182","13250","13251","13253","13254","13256","13258","11176","11178","11179","11180","11181","11182","11183","11184","11185","11187","11189","11191","11192","11193","11194","11197","11199","11198","11200","12895","12896","12897","12898","12977","12978","12979","12980","12981","12982","12894","12899","12900","12901","12902","12903","12983","12984","12975","12976","12950","12951","12952","12953","12954","12985","12986","12987","12988","12957","12989","12955","12956","12940","12941","12942","12944","12946","12993","12943","12991","12947","12990","12948","12992","12949","12937","12938","12936","12926","12927","12928","12929","12930","12931","12939","12932","12933","12934","12935","12974","12971","12958","12970","12969","12967","12963","12966","12972","12965","12964","12962","12968","12973","12961","12960","12959","8839","9276","9277","9287","10081","10085","10087","10088","8931","8932","8933","8934","8935","8936","8937","8938","8939","10545","10546","10547","10548","10549","10550","10551","10552","10553","8829","7901","11887","7905","7906","7908","7909","7910","7911","7912","7913","7914","7915","7920","7921","7922","7924","9322","9323","9328","9329","11860","11942","9332","9333","9334","9335","10591","10592","12173","12175","12177","12176","12178","12179","12180","12181","13230","13231","13232","13233","13234","13235","13238","13239","13241","13242","13243","13244","13245","13246","13247","13248","8886","8887","8888","8889","8890","8891","8896","8900","8915","8917","9448","9449","8804","8805","8806","12014","12015","11390","11389","11391","11392","11393","11394","11397","11396","11395","10244","10245","10246","10247","10248","11946","11945","11400","11401","10252","11402","11403","11406","11407","11404","11405","11408","11409","11410","11411","11412","11413","11414","11415","11416","11417","11419","11418","11420","11421","11323","11321","11322","11320","11318","11319","11310","11308","11309","11313","11311","11312","11328","11326","11327","11317","11315","11316","11301","11299","11300","11304","11302","11303","11307","11305","11306","11334","11332","11333","11340","11338","11339","11346","11344","11345","11352","11350","11351","11358","11356","11357","11364","11362","11363","11370","11368","11369","11376","11374","11375","11382","11380","11381","11388","11386","11387","11424","11425","11428","11429","11432","11433","","12924","12925","12907","12910","12909","12908","12911","12913","12917","12915","12916","12918","12922","12923","12919","11446","11447","11448","11449","11450","11451","10263","10264","10265","11452","11453","11454","11455","11444","11949","10273","10274","10275","10276","11948","10277","11445","11154","11297","11654","11653","11488","11456","11457","11458","11463","11156","11157","11464","7428","11220","11489","11296","11468","11469","11470","11472","11474","11476","11477","11478","11481","11484","11487","11491","11493","11495","11497","11499","12259","12258","10290","11599","8096","12890","10293","13108","11643","8099","11644","11646","13109","11247","11657","10298","11245","11658","11227","12257","10303","11230","11647","11648","11652","11649","11650","11105","11106","11242","11225","11238","12274","10312","10313","11228","10315","11232","11659","10316","11660","13110","11662","11664","10321","11666","11236","10323","11667","11668","11235","10328","11672","11669","11671","13111","13112","13113","13114","12862","10338","13115","13116","13117","13118","11233","12866","13119","12864","13120","12865","11023","11024","11025","11026","11064","11027","11028","11029","11030","11258","11032","11033","11034","11035","13128","12860","12807","12809","12808","12805","12806","11036","11037","11038","11039","11018","11019","11020","11021","11040","11041","11042","11043","11044","11045","11046","11047","11048","11049","11050","11051","11894","11056","11057","11058","11059","11060","11061","11062","11063","11255","11254","11252","11267","11261","11260","11259","11266","11265","11268","11264","8125","8140","8141","11680","8143","8144","11734","11735","11262","12874","11683","11681","11682","8147","8149","13122","13123","13124","13125","12861","12810","12811","12815","12812","12813","13127","11710","12816","12814","13126","10418","5617","12817","12819","12822","12824","12826","11684","11685","8127","8128","11251","11686","11687","11688","11689","8131","8132","8133","11690","8134","11692","11693","11170","11694","11695","11699","11700","11701","11730","11733","13218","13311","10378","13312","13313","13121","11729","8151","8152","11738","8153","8154","10383","11702","11703","11704","8156","8157","11739","8158","12491","11740","11741","11742","11743","11744","8163","8164","11707","11708","11745","8165","13107","8167","11293","11747","13315","13302","13304","10395","13129","11752","11751","13305","13303","10398","11722","11723","11724","13306","13307","11760","11761","11762","11763","11764","11768","11769","8179","8180","13132","13308","13309","11774","10416","8185","13131","11776","13130","11726","8189","12773","13213","13214","13215","13310","13219","13220","13221","8329","8330","8332","8333","8334","8335","8336","11796","8338","8339","8340","8341","8342","8343","8344","8345","8346","11808","8348","8349","8350","8351","8352","8353","8354","11810","8356","8357","8358","8359","8360","8361","8362","12183","8364","12184","8562","8563","8564","8565","8566","8567","8568","7577","8569","8570","7578","8571","8572","8573","8574","8575","8576","8577","8578","4656","7579","8579","8580","8581","8582","8583","8584","8586","8587","8588","8589","8590","8591","8592","8593","8594","8595","8596","8597","8598","8599","8600","8603","8617","8618","8619","8620","8621","7656","7658","8622","8623","8624","8625","4819","4820","7670","10484","10485","10486","10487","10488","10489","10490","10494","10495","10496","8287","10523","10524","8288","10525","10526","8835","8838","10583","8885","8940","8951","8952","10585","8954","8955","9041","9042","9058","9080","9081","9082","9083","10587","9084","12198","9087","9088","9089","9090","9091","9092","7934","9212","7940","9213","9214","7941","10588","7942","9253","10590","9254","9255","9256","7947","7948","9258","9259","9260","9261","9262","9272","12196","12197","12199","7992","9450","9451","9452","9460","9461","9462","9463","9464","9467","9468","10593","10594","9469","9470","9471","9472","9473","9474","10596","9537","9538","9559","9560","9561","9562","9563","10598","9565","9566","10599","9567","10600","8002","10601","9570","10840","12200","9572","10602","9683","9684","9685","9686","9687","9688","9706","9707","9718","9719","8025","9769","9770","9772","9781","9782","9783","9784","10606","9785","9792","9793","9794","9795","9796","9906","9981","9982","9983","9984","9985","9986","10610","9987","9988","9989","9990","9991","9992","9993","9994","10611","10612","9995","10613","9996","9997","8062","9998","9999","10000","10001","10006","10007","10008","10009","10010","10043","10044","10045","8064","10614","10055","10056","12201","10057","10058","10616","8065","8066","10095","10096","10097","10098","10099","10100","10104","8068","10105","10119","10121","10122","10129","10130","10131","10132","10136","10139","10140","10157","10158","10159","8077","10617","10160","5423","7274","10162","10618","10165","10166","10184","10185","10186","10187","10619","10188","10620","10189","10190","10621","7279","10194","10206","10228","10229","10230","10231","9057","9208","9271","9465","9466","9489","9490","9491","9492","9493","9494","9495","9496","9497","9498","9499","9500","9501","9502","9503","9568","9569","9573","9574","9575","9576","9630","9631","9635","9636","9639","9640","9641","9642","9680","9711","9712","9713","9714","9715","9716","9717","9720","9767","9768","10605","9771","10120","10134","10138","10152","10153","10154","10155","10156","10161","10207","10208","10209","7671","7672","7673","7674","7675","11952","11951","11953","11954","7680","11969","11962","11963","11964","11956","11958","11965","11970","8922","9299","12034","5341","5342","5343","12035","12036","10144","5414","5416","10146","5417","12041","12042","12043","12037","12039","12040","7926","9079","7949","9285","7950"];
      
      let iterateIds = _.map(ids, i => {
        return Promise.any([
          getImg(i,'jpg'),
          getImg(i,'png'),
          getImg(i,'jpeg')
        ]).then((result) => {
          return result;
        });
      });

      Promise.all(iterateIds).then(result => {
        let list = _.compact(result);
        let iterateFilterIds = _.map(list, im => {
          // console.log('http://kupi-korm.ru/pictures/product/small/' + im);
          axios({
            method:'get',
            url:'http://kupi-korm.ru/pictures/product/small/' + im,
            responseType:'stream'
          }).then(response => {
            let fileName = im;
            let file = bucket.file('shop/' + fileName);
            tmp.file( (err, path, fd, cleanupCallback) => {
              if (err) throw err;
              response.data.pipe(fs.createWriteStream(path, { fd: fd }));
              fs.createReadStream(path)
                .pipe(file.createWriteStream({
                  metadata: {
                    contentType: 'image/jpeg'
                  }
                }))
                .on('error', function(err) {
                  console.log(err);
                })
                .on('finish', function() {
                  file.makePublic().then(() => {
                    console.log('https://storage.googleapis.com/divemby-fb.appspot.com/shop/' + fileName);
                    cleanupCallback();
                  });
                });
            });
          });

        });

        Promise.all(iterateFilterIds).then(result => {
          res.json({status: "OK"});
        }, err => {
          res.status(500).json({status: "ERROR", err: err });
        });
        
      }, err => {
        res.status(500).json({});
      });
      // if (ids && _.isArray(ids) && ids.length > 0) {
      //   var badIds = [];
      //   let iterateIds = _.map(ids, i => {
      //     // console.log(i);
      //     axios({
      //       method:'get',
      //       url:'http://kupi-korm.ru/pictures/product/small/' + i + '_small.jpeg',
      //       responseType:'stream'
      //     }).then(response => {
      //       console.log('g', i);
      //       // let fileName = i + '_small.jpg';
      //       // let file = bucket.file('shop/' + fileName);
      //       // tmp.file( (err, path, fd, cleanupCallback) => {
      //       //   if (err) throw err;
      //       //   response.data.pipe(fs.createWriteStream(path, { fd: fd }));
      //       //   fs.createReadStream(path)
      //       //     .pipe(file.createWriteStream())
      //       //     .on('error', function(err) {
      //       //       console.log(err);
      //       //     })
      //       //     .on('finish', function() {
      //       //       file.makePublic().then(() => {
      //       //         console.log('https://storage.googleapis.com/divemby-fb.appspot.com/shop/' + fileName);
      //       //         cleanupCallback();
      //       //       });
      //       //     });
      //       // });
      //     }, err => {

      //       // axios({
      //       //   method:'get',
      //       //   url:'http://kupi-korm.ru/pictures/product/small/' + i + '_small.png',
      //       //   responseType:'stream'
      //       // }).then(response => {
      //       //   let fileName = i + '_small.png';
      //       //   let file = bucket.file('shop/' + fileName);
      //       //   tmp.file( (err, path, fd, cleanupCallback) => {
      //       //     if (err) throw err;
      //       //     response.data.pipe(fs.createWriteStream(path, { fd: fd }));
      //       //     fs.createReadStream(path)
      //       //       .pipe(file.createWriteStream())
      //       //       .on('error', function(err) {
      //       //         console.log(err);
      //       //       })
      //       //       .on('finish', function() {
      //       //         file.makePublic().then(() => {
      //       //           console.log('https://storage.googleapis.com/divemby-fb.appspot.com/shop/' + fileName);
      //       //           cleanupCallback();
      //       //         });
      //       //       });
      //       //   });
      //       // });
      //       console.log('bad', i);
      //     });
      //   });

      //   Promise.all(iterateIds).then(result => {
      //     console.log(badIds);
      //     res.json({status: "OK"});
      //   }, err => {
      //     res.status(500).json({status: "ERROR", err: err });
      //   });

      // } else {
      //   return res.status(400).json({status: "INVALID_REQUEST"});
      // }
    }
  }
}